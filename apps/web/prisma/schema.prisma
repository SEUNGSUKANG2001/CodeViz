generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(uuid()) @db.Uuid
  username    String?  @unique
  displayName String?  @map("display_name")
  bio         String?
  avatarUrl   String?  @map("avatar_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  identities UserIdentity[]
  sessions   Session[]
  projects   Project[]
  posts      Post[]
  comments   Comment[]
  postLikes  PostLike[]
  followers  UserFollow[]   @relation("following")
  following  UserFollow[]   @relation("follower")
  uploads    Upload[]

  @@map("users")
}

model UserIdentity {
  id             String  @id @default(uuid()) @db.Uuid
  userId         String  @map("user_id") @db.Uuid
  provider       String // 'kakao', 'github'
  providerUserId String  @map("provider_user_id")
  accessToken    String? @map("access_token")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@map("user_identities")
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.Uuid
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@map("sessions")
}

enum ProjectStatus {
  draft
  ready
  error
}

model Project {
  id            String        @id @default(uuid()) @db.Uuid
  ownerId       String        @map("owner_id") @db.Uuid
  repoUrl       String        @map("repo_url")
  ref           String?
  title         String
  currentConfig Json          @default("{}") @map("current_config")
  coverUrl      String?       @map("cover_url")
  status        ProjectStatus @default(draft)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  owner     User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  jobs      AnalysisJob[]
  snapshots Snapshot[]

  @@map("projects")
}

enum JobStatus {
  queued
  running
  done
  failed
  canceled
}

model AnalysisJob {
  id           String    @id @default(uuid()) @db.Uuid
  projectId    String    @map("project_id") @db.Uuid
  status       JobStatus @default(queued)
  progress     Float?
  message      String?
  resultUrl    String?   @map("result_url")
  statsJson    Json?     @map("stats_json")
  errorMessage String?   @map("error_message")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  snapshots Snapshot[]

  @@index([projectId, createdAt(sort: Desc)])
  @@map("analysis_jobs")
}

model Snapshot {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  jobId     String?  @map("job_id") @db.Uuid
  config    Json     @default("{}")
  coverUrl  String?  @map("cover_url")
  createdAt DateTime @default(now()) @map("created_at")

  project Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  job     AnalysisJob? @relation(fields: [jobId], references: [id], onDelete: SetNull)
  posts   Post[]

  @@map("snapshots")
}

enum PostVisibility {
  public
  unlisted
  private
}

model Post {
  id         String         @id @default(uuid()) @db.Uuid
  snapshotId String         @map("snapshot_id") @db.Uuid
  authorId   String         @map("author_id") @db.Uuid
  title      String
  body       String?
  repoUrl    String?        @map("repo_url")
  tags       String[]       @default([])
  visibility PostVisibility @default(public)
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")

  snapshot Snapshot   @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  author   User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments Comment[]
  likes    PostLike[]

  @@index([authorId, createdAt(sort: Desc)])
  @@index([visibility, createdAt(sort: Desc)])
  @@map("posts")
}

model Comment {
  id        String   @id @default(uuid()) @db.Uuid
  postId    String   @map("post_id") @db.Uuid
  authorId  String   @map("author_id") @db.Uuid
  body      String
  parentId  String?  @map("parent_id") @db.Uuid
  isDeleted Boolean  @default(false) @map("is_deleted")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  post    Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author  User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")

  @@index([postId, createdAt])
  @@map("comments")
}

model PostLike {
  id        String   @id @default(uuid()) @db.Uuid
  postId    String   @map("post_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("post_likes")
}

model UserFollow {
  id          String   @id @default(uuid()) @db.Uuid
  followerId  String   @map("follower_id") @db.Uuid
  followingId String   @map("following_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  follower  User @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@map("user_follows")
}

enum UploadType {
  post_cover
  avatar
}

model Upload {
  id          String     @id @default(uuid()) @db.Uuid
  type        UploadType
  publicUrl   String     @map("public_url")
  s3Key       String     @map("s3_key")
  contentType String     @map("content_type")
  createdBy   String     @map("created_by") @db.Uuid
  createdAt   DateTime   @default(now()) @map("created_at")

  user User @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("uploads")
}
